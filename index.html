<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rian Store — SMM Mobile</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
:root{
  --primary:#8B4513;
  --bg:#f6f6f7;
  --card:#ffffff;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#ef4444;
  --radius:12px;
  font-family: system-ui, -apple-system, "Helvetica Neue", Roboto, "Segoe UI", "Noto Sans", "Poppins", Arial;
}
html,body{height:100%;margin:0;background:var(--bg);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
.app{max-width:540px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}
header.appbar{background:var(--primary);color:white;padding:14px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:40;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.brand{display:flex;align-items:center;gap:10px;}
.logo{width:40px;height:40px;border-radius:10px;background:#fff1e6;color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;}
.title{font-size:16px;font-weight:700;line-height:1;}
.subtitle{font-size:12px;color:#ffe9d9;opacity:0.95;margin-top:2px;}
main{padding:14px;flex:1;}
.card{background:var(--card);border-radius:var(--radius);padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
select,input{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e6e9;font-size:15px;box-sizing:border-box;}
.row{display:flex;gap:8px}
.col{flex:1}
.btn{display:inline-block;background:var(--primary);color:#fff;padding:12px;border-radius:10px;border:0;font-weight:700;font-size:15px;width:100%;cursor:pointer;box-shadow:0 6px 18px rgba(139,69,19,0.12);}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(139,69,19,0.14);box-shadow:none;}
.muted{color:var(--muted);font-size:13px}
.service-list{display:flex;flex-direction:column;gap:10px;margin-top:8px;}
.service-item{padding:12px;border-radius:10px;background:#fff;display:flex;justify-content:space-between;align-items:flex-start;gap:10px;border:1px solid #f0f0f0}
.svc-left{flex:1}
.svc-title{font-weight:700;font-size:14px;margin-bottom:6px}
.svc-desc{font-size:13px;color:var(--muted);line-height:1.4}
.svc-meta{font-size:12px;color:var(--muted);margin-top:8px}
.price{font-weight:800;color:var(--primary);font-size:14px}
.small{font-size:12px;color:var(--muted)}
.note{background:#fff7ef;padding:8px;border-radius:8px;border:1px solid #fff0e6;color:#6b3b1a;font-size:13px;}
footer{padding:10px;text-align:center;font-size:13px;color:var(--muted)}
.overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:90}
.overlay.show{display:flex}
.modal{width:100%;max-width:520px;background:var(--card);border-radius:12px;padding:14px;box-shadow:0 20px 40px rgba(2,6,23,0.3)}
.desc-box{background:#f7f5f3;border-radius:10px;padding:10px;font-size:13px;color:#3b2a1f}
pre{white-space:pre-wrap;background:#0b1220;color:#e6eef8;padding:8px;border-radius:8px;overflow:auto;font-size:12px}
.history-item{padding:8px;border-bottom:1px dashed #eee}
.tag{display:inline-block;background:#fff2e6;color:var(--primary);padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
@media(min-width:560px){ main{padding:18px} }
</style>
</head>
<body>
<div class="app">
  <header class="appbar" role="banner">
    <div class="brand">
      <div class="logo">R</div>
      <div>
        <div class="title">Rian Store</div>
        <div class="subtitle small">SMM Panel — Mobile</div>
      </div>
    </div>
  </header>

  <main role="main">
    <!-- Saldo User -->
    <div class="card" id="saldo-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Saldo Anda</div>
        <div style="font-weight:800" id="user-saldo">Rp 0</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <div style="font-weight:800">Pilih Kategori</div>
          <div class="muted small">Pilih kategori terlebih dahulu lalu layanan Best Seller akan tampil</div>
        </div>
        <div style="text-align:right">
          <div class="small muted">Riwayat lokal</div>
          <div style="font-weight:800" id="history-count">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <label for="category">Kategori</label>
      <select id="category" aria-label="Pilih kategori">
        <option value="">-- Pilih kategori --</option>
      </select>
      <div style="margin-top:6px" id="cat-note" class="small muted">Muat layanan dari IndoSMM jika kategori tidak muncul.</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" id="btn-refresh">Muat Layanan</button>
        <button class="btn ghost" id="btn-clear-history">Hapus Riwayat</button>
      </div>
    </div>

    <div id="services-region" class="card" style="padding-bottom:6px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800">Layanan • Best Seller</div>
        <div class="small muted">Tampilkan layanan berlabel Best Seller</div>
      </div>

      <div id="services" class="service-list">
        <div class="muted small">Belum ada layanan. Tekan "Muat Layanan".</div>
      </div>
    </div>

    <footer class="muted small">Terhubung ke: <code>https://indosmm.id/api/v2</code></footer>
  </main>
</div>

<div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
      <div>
        <div id="modal-service-name" style="font-weight:800"></div>
        <div id="modal-service-meta" class="small muted"></div>
      </div>
      <div style="text-align:right">
        <div class="tag">Best Seller</div>
      </div>
    </div>

    <div class="desc-box" id="modal-desc" style="margin-bottom:10px"></div>

    <label>Link / Username / Nomor</label>
    <input id="order-link" placeholder="Contoh: https://instagram.com/username atau username atau 0812xxxx">

    <div style="display:flex;gap:8px;margin-top:8px">
      <div class="col">
        <label>Jumlah</label>
        <input id="order-qty" type="number" placeholder="Contoh: 100" min="1">
      </div>
      <div style="width:120px">
        <label>Rate</label>
        <input id="order-rate" readonly>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <div style="flex:1">
        <div id="price-with-markup" style="font-weight:800;color:var(--primary)">Rp 0</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn ghost" id="modal-cancel">Batal</button>
      <button class="btn" id="modal-submit">Kirim Pesanan</button>
    </div>

    <div id="modal-status" style="margin-top:10px"></div>

    <div style="margin-top:12px">
      <strong>Riwayat lokal (terbaru)</strong>
      <div id="modal-history" style="max-height:220px;overflow:auto;margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
// ====== KONFIGURASI ======
const CONFIG = {
  API_URL: 'https://indosmm.id/api/v2',          // API SMM Anda
  API_KEY: '2289abee4234d95fbae66eedaf7e4e72',         // API key IndoSMM
  MARKUP: 0.30,                                 // markup harga
  BUKA_DOMAIN: 'https://pulsaku09.olshopku.com',       // domain BukaOlshop Anda
  BUKA_TOKEN: 'NWVrY1FCRUdCL05UaUY4eEZvblUxUHBSQ09NRnl3WndSZHdnTFdmdEVDeGYwYnlKbCtXT2orUTdNTC9ibnFRUHUvRlA5MG1FMEg5RExCc2FFWnh6OERheGJPWXBVZlpWYklFQko5cFlzQkx5Y0JlWXdEdWVScWFpZkVCUmh5WDRUdzZ6TWh4TGFYeDZFR3ZScDFiYTExbGxXZExvMzEzZ1VUM2Nob0hacnJFSTlWa2g3RzE5b3NQeXdTNEhMQkhl='      // token API BukaOlshop
};

// ====== ELEMENT ======
const el = {
  btnRefresh: document.getElementById('btn-refresh'),
  btnClearHistory: document.getElementById('btn-clear-history'),
  category: document.getElementById('category'),
  servicesList: document.getElementById('services'),
  historyCount: document.getElementById('history-count'),
  overlay: document.getElementById('overlay'),
  modalServiceName: document.getElementById('modal-service-name'),
  modalServiceMeta: document.getElementById('modal-service-meta'),
  modalDesc: document.getElementById('modal-desc'),
  orderLink: document.getElementById('order-link'),
  orderQty: document.getElementById('order-qty'),
  orderRate: document.getElementById('order-rate'),
  priceWithMarkup: document.getElementById('price-with-markup'),
  modalCancel: document.getElementById('modal-cancel'),
  modalSubmit: document.getElementById('modal-submit'),
  modalStatus: document.getElementById('modal-status'),
  modalHistory: document.getElementById('modal-history'),
  userSaldo: document.getElementById('user-saldo')
};

let ALL_SERVICES = [];
let FILTERED_SERVICES = [];
let CATEGORIES = [];
let CURRENT_SERVICE = null;
let ORDERS = loadLocalOrders();

// ====== UTILITY ======
function fmtRp(n){ n = Number(n)||0; return 'Rp ' + Math.round(n).toLocaleString('id-ID'); }
function showToast(msg, ms=1400){ const t = document.createElement('div'); t.style.position='fixed'; t.style.left='50%'; t.style.bottom='80px'; t.style.transform='translateX(-50%)'; t.style.background='rgba(0,0,0,0.8)'; t.style.color='white'; t.style.padding='8px 12px'; t.style.borderRadius='8px'; t.style.zIndex=9999; t.style.fontSize='13px'; t.textContent = msg; document.body.appendChild(t); setTimeout(()=>{ t.style.transition='all 300ms'; t.style.opacity=0; t.style.bottom='70px'; }, ms); setTimeout(()=> t.remove(), ms+400); }
function loadLocalOrders(){ try{ const raw = localStorage.getItem('rs_orders'); return raw?JSON.parse(raw):[];}catch(e){return [];} }
function saveLocalOrders(){ localStorage.setItem('rs_orders', JSON.stringify(ORDERS)); updateHistoryUI(); }
function addLocalOrder(rec){ ORDERS.unshift(rec); if(ORDERS.length>300) ORDERS.length=300; saveLocalOrders(); }

function updateHistoryUI(){ el.historyCount.textContent = ORDERS.length; renderModalHistory(); }
function renderModalHistory(){ el.modalHistory.innerHTML=''; if(!ORDERS || ORDERS.length===0){ el.modalHistory.innerHTML='<div class="muted small">Belum ada riwayat.</div>'; return;} for(const o of ORDERS.slice(0,40)){ const d = new Date(o.createdAt).toLocaleString(); const node=document.createElement('div'); node.className='history-item'; node.innerHTML=`<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(o.service_name||o.service)}</strong><div class="small muted">${escapeHtml(o.target||'')}</div></div><div style="text-align:right" class="small muted">${escapeHtml(String(o.id||'-'))}<div>${d}</div></div></div>`; el.modalHistory.appendChild(node); } }

function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

// ====== FETCH LAYANAN ======
async function fetchServices(){
  try{
    const body=new URLSearchParams();
    body.append('key', CONFIG.API_KEY);
    body.append('action','services');
    const res=await fetch(CONFIG.API_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body.toString()});
    const text=await res.text();
    let data;
    try{ data=JSON.parse(text);}catch(e){throw new Error('Respon layanan tidak valid');}
    let arr=Array.isArray(data)?data:(Array.isArray(data.services)?data.services:(Array.isArray(data.result)?data.result:(Array.isArray(data.data)?data.data:Object.values(data).filter(v=>(v&& (v.service||v.name||v.id))))));
    ALL_SERVICES=arr.map(s=>({ 
        raw:s, 
        service:s.service||s.id||s.code||'', 
        name:s.name||s.title||s.nama||(s.service?String(s.service):''), 
        desc:s.desc||s.description||s.details||'Deskripsi layanan tersedia', 
        rate:Number(s.rate||s.price||s.harga||0), 
        min:s.min||s.minimum||s.min_order||null, 
        max:s.max||s.maximum||s.max_order||null, 
        category:s.category||s.group||s.kategori||s.type||'Umum'
    }));
    FILTERED_SERVICES=ALL_SERVICES.filter(s=>String(s.name).toLowerCase().includes('best seller'));
    CATEGORIES=Array.from(new Set(FILTERED_SERVICES.map(s=>s.category||'Umum')));
    renderCategories(); 
    renderServicesList(); 
    showToast('Layanan berhasil dimuat');
  }catch(err){ 
    console.error(err); 
    el.servicesList.innerHTML='<div class="muted small">Gagal memuat layanan. Periksa koneksi atau API key.</div>'; 
    alert('Gagal memuat layanan: '+(err.message||err)); 
  }
}

function renderCategories(){
  const sel=el.category; 
  sel.innerHTML='<option value="">-- Pilih kategori --</option>';
  for(const c of CATEGORIES){ 
    const opt=document.createElement('option'); 
    opt.value=c; 
    opt.textContent=c; 
    sel.appendChild(opt);
  }
  document.getElementById('cat-note').textContent = CATEGORIES.length? 
    'Pilih kategori untuk menampilkan layanan Best Seller.' : 
    'Tidak ada kategori Best Seller. Tekan "Muat Layanan".';
}

function renderServicesList(){
  const region=el.servicesList; 
  region.innerHTML=''; 
  const cat=el.category.value; 
  const list=FILTERED_SERVICES.filter(s=>(!cat||s.category===cat));
  if(list.length===0){ 
    region.innerHTML='<div class="muted small">Tidak ada layanan di kategori ini.</div>'; 
    return;
  }
  for(const s of list){
    const item=document.createElement('div'); 
    item.className='service-item';
    const rateUp = Number(s.rate)*(1+CONFIG.MARKUP);
    const priceTxt = rateUp?fmtRp(rateUp)+' / 1000':'-';
    item.innerHTML=`<div class="svc-left"><div class="svc-title">${escapeHtml(s.name)}</div><div class="svc-desc">${escapeHtml(s.desc||'Deskripsi layanan tersedia.')}</div><div class="svc-meta small">Min: ${s.min||'-'} • Max: ${s.max||'-'} • ${escapeHtml(String(s.service))}</div></div><div style="text-align:right"><div class="price small">${priceTxt}</div><div style="margin-top:10px"><button class="btn-buy btn" data-svc="${escapeHtml(s.service)}">Pilih</button></div></div>`;
    region.appendChild(item);
  }
  document.querySelectorAll('.btn-buy').forEach(b=>b.addEventListener('click',e=>openOrderModal(e.currentTarget.dataset.svc)));
}

function openOrderModal(serviceCode){
  const s=FILTERED_SERVICES.find(x=>String(x.service)===String(serviceCode));
  CURRENT_SERVICE=s||{service:serviceCode,name:serviceCode,rate:0,min:null,max:null,desc:''};
  el.modalServiceName.textContent=CURRENT_SERVICE.name||CURRENT_SERVICE.service;
  el.modalServiceMeta.textContent=`Service: ${CURRENT_SERVICE.service} • Min: ${CURRENT_SERVICE.min||'-'} • Max: ${CURRENT_SERVICE.max||'-'}`;
  el.modalDesc.textContent = CURRENT_SERVICE.desc || 'Deskripsi layanan tersedia.';
  const rateUp = Number(CURRENT_SERVICE.rate)*(1+CONFIG.MARKUP);
  el.orderRate.value = rateUp ? fmtRp(rateUp) : '-';
  updateTotalPrice();
  el.overlay.classList.add('show');
}

function closeOrderModal(){
  el.overlay.classList.remove('show');
  el.orderLink.value='';
  el.orderQty.value='';
  el.orderRate.value='';
  el.priceWithMarkup.textContent='Rp 0';
  el.modalStatus.innerHTML='';
}

function updateTotalPrice(){
  const qty = Number(el.orderQty.value)||0;
  const rate = Number(CURRENT_SERVICE.rate)*(1+CONFIG.MARKUP)||0;
  const total = qty * rate / 1000;
  el.priceWithMarkup.textContent = fmtRp(total);
}

el.orderQty.addEventListener('input',updateTotalPrice);
el.modalCancel.addEventListener('click',closeOrderModal);

// ====== FETCH SALDO USER BUKAOLSHOP ======
async function fetchUserSaldo() {
  try {
    const res = await fetch(`https://${CONFIG.BUKA_DOMAIN}/v1/user/info?token=${CONFIG.BUKA_TOKEN}`);
    const data = await res.json();
    if(data && data.data && data.data.jumlah_saldo !== undefined){
      const saldo = Number(data.data.jumlah_saldo) || 0;
      el.userSaldo.textContent = fmtRp(saldo);
      return saldo;
    } else {
      el.userSaldo.textContent = 'Rp 0';
      return 0;
    }
  } catch(err){
    console.error('Gagal ambil saldo:', err);
    el.userSaldo.textContent = 'Error';
    return 0;
  }
}

// ====== SUBMIT PESANAN ======
el.modalSubmit.addEventListener('click', async ()=>{
  const target = el.orderLink.value.trim();
  const qty = Number(el.orderQty.value)||0;
  const rateUp = Number(CURRENT_SERVICE.rate)*(1+CONFIG.MARKUP);
  const totalPrice = qty*rateUp/1000;

  if(!target){ alert('Masukkan link/username/nomor'); return; }
  if(qty<1){ alert('Masukkan jumlah valid'); return; }

  const saldo = await fetchUserSaldo();
  if(totalPrice > saldo){
    alert('Saldo Anda tidak cukup untuk transaksi ini.');
    return;
  }

  const order = {
    id: Date.now(),
    service: CURRENT_SERVICE.service,
    service_name: CURRENT_SERVICE.name,
    target: target,
    qty: qty,
    rate: rateUp,
    total: totalPrice,
    createdAt: new Date().toISOString()
  };
  addLocalOrder(order);
  showToast('Pesanan berhasil ditambahkan ke riwayat lokal');
  closeOrderModal();
});

// ====== EVENT ======
el.btnRefresh.addEventListener('click',fetchServices);
el.btnClearHistory.addEventListener('click',()=>{
  if(confirm('Hapus semua riwayat lokal?')){
    ORDERS=[]; saveLocalOrders(); showToast('Riwayat lokal dihapus');
  }
});
el.category.addEventListener('change',renderServicesList);

async function init(){
  updateHistoryUI();
  await fetchUserSaldo();
}

init();
</script>
</body>
</html>
